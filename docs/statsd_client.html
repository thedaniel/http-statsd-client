<!DOCTYPE html>  <html> <head>   <title>statsd_client.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               statsd_client.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This is a simple client for the http fork of statsd found at
https://github.com/thedaniel/statsd . It sends XHR PUTs in the form that
statsd expects, and optionally bundles metrics to reduce the number of
requests made. Its public interface is based on the python client example in
statsd.</p>

<p>It is initialized with a params object that controls how the stats are
batched to be sent to statsd, and where the stats are sent. If you have your
own ajax manager, you can optionally pass it in, otherwise jQuery's is
used. jQuery is otherwise not required.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">StatsdClient</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">host</span> <span class="o">||</span> <span class="s1">&#39;http://127.0.0.1:8126&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">bundleSize</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">bundleSize</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ajax</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">ajax</span> <span class="o">||</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_stats</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>Public Interface</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>All of these methods take stats as the first positional variable. It can be
a string representing the stat name or an array of stats to update all at
once.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Log timing information</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">StatsdClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">timing</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stats</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">sampleRate</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">sampleRate</span> <span class="o">=</span> <span class="nx">sampleRate</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">update_stats</span><span class="p">(</span><span class="nx">stats</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">sampleRate</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Increment a counter</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">StatsdClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">increment</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stats</span><span class="p">,</span> <span class="nx">sampleRate</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">sampleRate</span> <span class="o">=</span> <span class="nx">sampleRate</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">update_stats</span><span class="p">(</span><span class="nx">stats</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">sampleRate</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>decrement a counter</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">StatsdClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">decrement</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stats</span><span class="p">,</span> <span class="nx">sampleRate</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">sampleRate</span> <span class="o">=</span> <span class="nx">sampleRate</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">update_stats</span><span class="p">(</span><span class="nx">stats</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">sampleRate</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>The update_stats method adds the stat to the list at this.stats and checks to see if
there are enough stats to flush, based on the bundleSize parameter that
StatsdClient was initialized with</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">StatsdClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update_stats</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">stat</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">stat</span> <span class="o">=</span> <span class="p">[</span><span class="nx">stat</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">stat</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_stats</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stat</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_stats</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bundleSize</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_flush</span><span class="p">();</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h1>Private Interface</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h3>_flush</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>This simply takes the stats available and sends them to statsd in the
correct format</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">StatsdClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_flush</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_stats</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;attempted to flush empty stats&#39;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">putData</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_stats</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span>
      <span class="p">{</span>
        <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="nx">m</span><span class="o">:</span> <span class="nx">putData</span><span class="p">}</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h1>Notes</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <ul>
<li>This was originally written for an environment that ignored cross-domain problems</li>
<li>This should probably be a commonJS module</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 